---
title: '13. SQLServer : 常规命令'
date: '2022-11-11 18:02'
tags: ['SQLServer', 'Database', 'EXECUTE', 'EXEC']
draft: false
layout: PostLayout
summary: EXECUTE（EXEC）是SQL Server中执行存储过程或动态SQL语句的关键命令。它用于调用预编译的存储过程（提高性能）或运行动态生成的SQL（灵活处理不确定查询条件）。通过EXEC 过程名 参数调用存储过程，或用EXEC('SQL语句')执行动态SQL。支持输入/输出参数，但动态SQL需注意SQL注入风险，建议使用参数化查询（sp_executesql）。典型应用于业务逻辑封装、权限控制和复杂查询构建。
---

<TOCInline toc={props.toc} />

### EXECUTE(简写EXEC)

#### 使用 EXECUTE 传递单个参数

```SQL
-- 执行存储过程
--EXEC dbo.uspGetEmployeeManagers @EmployeeID = 6;
EXEC dbo.uspGetEmployeeManagers 6;   -- 单个参数时不用声明
GO
```

#### 使用多个参数

```SQL
DECLARE @CheckDate DATETIME;
SET @CheckDate = GETDATE();
EXEC dbo.uspGetWhereUsedProductID 819, @CheckDate;
```

### EXECUTE 'tsql_string'

```SQL
declare @str nvarchar(255) = 'select * from Production.Product'
EXECUTE(@str)
```

#### 对远程存储过程使用 EXECUTE 语句

```SQL
DECLARE @retstat INT;
EXECUTE @retstat = SQLSERVER1.AdventureWorks2012.dbo.uspGetEmployeeManagers @BusinessEntityID = 6;
```

#### 使用带存储过程变量的 EXECUTE 语句

```SQL
DECLARE @proc_name VARCHAR(30);
SET @proc_name = 'sys.sp_who';
EXEC @proc_name;
```

#### 使用带 DEFAULT 的 EXECUTE

```SQL
-- 创建存储过程
IF OBJECT_ID(N'dbo.ProcTestDefaults', N'P')IS NOT NULL
  DROP PROCEDURE dbo.ProcTestDefaults;
GO
-- Create the stored procedure.
CREATE PROCEDURE dbo.ProcTestDefaults (
@p1 SMALLINT = 42,
@p2 CHAR(1),
@p3 VARCHAR(8) = 'CAR')
AS
  SET NOCOUNT ON;
  SELECT @p1, @p2, @p3
;
GO


-- 执行存储过程
-- Specifying a value only for one parameter (@p2).
EXECUTE dbo.ProcTestDefaults @p2 = 'A';
-- Specifying a value for the first two parameters.
EXECUTE dbo.ProcTestDefaults 68, 'B';
-- Specifying a value for all three parameters.
EXECUTE dbo.ProcTestDefaults 68, 'C', 'House';
-- Using the DEFAULT keyword for the first parameter.
EXECUTE dbo.ProcTestDefaults @p1 = DEFAULT, @p2 = 'D';
-- Specifying the parameters in an order different from the order defined in the procedure.
EXECUTE dbo.ProcTestDefaults DEFAULT, @p3 = 'Local', @p2 = 'E';
-- Using the DEFAULT keyword for the first and third parameters.
EXECUTE dbo.ProcTestDefaults DEFAULT, 'H', DEFAULT;
EXECUTE dbo.ProcTestDefaults DEFAULT, 'I', @p3 = DEFAULT;

```

#### 对用户定义函数使用 EXECUTE

```SQL
DECLARE @returnstatus NVARCHAR(15);
SET @returnstatus = NULL;
EXEC @returnstatus = dbo.ufnGetSalesOrderStatusText @Status = 2;
PRINT @returnstatus;
GO
```

#### 使用 EXECUTE 重新定义单个结果集

```sql
-- 对存储过程的返回结果重新定义列
EXEC uspGetEmployeeManagers 6
WITH RESULT SETS
(
   ([Reporting Level] INT NOT NULL,
    [ID of Employee] INT NOT NULL,
    [Employee First Name] NVARCHAR(50) NOT NULL,
    [Employee Last Name] NVARCHAR(50) NOT NULL,
    [Employee ID of Manager] NVARCHAR(max) NOT NULL,
    [Manager First Name] NVARCHAR(50) NOT NULL,
    [Manager Last Name] NVARCHAR(50) NOT NULL )
);
```

#### 使用 EXECUTE 重新定义两个结果集

```SQL
CREATE PROC Production.ProductList @ProdName NVARCHAR(50)
AS
-- First result set
SELECT ProductID, Name, ListPrice
    FROM Production.Product
    WHERE Name LIKE @ProdName;
-- Second result set
SELECT Name, COUNT(S.ProductID) AS NumberOfOrders
    FROM Production.Product AS P
    JOIN Sales.SalesOrderDetail AS S
        ON P.ProductID  = S.ProductID
    WHERE Name LIKE @ProdName
    GROUP BY Name;
GO

-- Execute the procedure
EXEC Production.ProductList '%tire%'
WITH RESULT SETS
(
    (ProductID INT,   -- first result set definition starts here
    Name NAME,
    ListPrice MONEY)
    ,                 -- comma separates result set definitions
    (Name NAME,       -- second result set definition starts here
    NumberOfOrders INT)
);
```

#### 在运行时确定的名称调用存储过程

```SQL
EXEC ('EXEC ' + @var);
```
